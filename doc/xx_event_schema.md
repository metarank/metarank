# Supported events

Metarank expects to receive a predefined set of events, describing visitor activity and item metadata:
1. Metadata events. They describe what should be known about items.
2. Ranking events. What was presented to the visitor.
3. Interaction events. What visitor did with the ranking.

## Event format

Metarank expects to receive these events in JSON format for simplicity. There is also a plan to add support for protobuf
in some future version. Each event has two shared required fields:
* id - which is a unique identifier for the event, should be generated by your app
* timestamp - number of milliseconds from 1970-01-01T00:00:00

There is also a shared optional "tenant" field for multi-tenancy cases.

## Item metadata events

An example item metadata event is in the block below. It describes a typical product in a ecommerce store.
```json
{
  "id": "81f46c34-a4bb-469c-8708-f8127cd67d27",
  "item": "product1", // required
  "timestamp": "1599391467000", // required
  "fields": [
    {"name": "title", "value": "Nice jeans"},
    {"name": "price", "value": 25.0},
    {"name": "color", "value": ["blue", "black"]},
    {"name": "availability", "value": true}
  ]
}
```

`fields` field is an optional array of name-value tuples, where value can be any of the following types:
* boolean
* string
* number
* list of strings
* list of numbers

## Impression events

When you show a listing of items to the visitor, Metarank needs to know what was displayed and in which ordering:

```json
{
  "id": "81f46c34-a4bb-469c-8708-f8127cd67d27",// required
  "timestamp": "1599391467000",// required
  "user": "user1",// required
  "session": "session1",// required
  "fields": [
      {"name": "query", "value": "jeans"},
      {"name": "source", "value": "search"}
  ],
  "items": [
    {"id": "product3", "relevancy":  2.0},
    {"id": "product1", "relevancy":  1.0},
    {"id": "product2", "relevancy":  0.5} 
  ]
}
```

* id: a request identifier later used to join impression and interaction events
* user: an unique visitor identifier
* session: a single visitor may have multiple sessions.
* fields: the same rules as for metadata events, a set of extra fields describing the listing
* items: which particular items were displayed to the visitor.
* items.relevancy: a score which was used to rank these items. For example, it can be BM25/tfidf score coming from ElasticSearch


## Interaction events

When visitor interacts with a ranking, you need to supply the following event:

```json
{
  "id": "0f4c0036-04fb-4409-b2c6-7163a59f6b7d",// required
  "impression": "81f46c34-a4bb-469c-8708-f8127cd67d27",
  "timestamp": "1599391467000",// required
  "user": "user1",// required
  "session": "session1",// required
  "type": "purchase",// required
  "item": "product1",// required
  "fields": [
    {"name": "count", "value": 2},
    {"name": "shipping", "value": "DHL"}
  ],
}
```

Apart from common id/timestamp/user/session fields, there are two other required ones:
* impression_id: an identifier of the parent impression event
* type: which type of interaction it was, so you can distinguish between clicks and purchases later
* item: which item was interacted with. If there were many interactions (like when customer bought multiple things at once),
   then you need to emit multiple events for each item.
* fields: a set of extra bits of information about the interaction.